# å‡çº§åŠŸèƒ½ä¿®å¤æ–¹æ¡ˆ

## é—®é¢˜æè¿°

æ‚¨é‡åˆ°çš„é—®é¢˜æ˜¯ï¼š**åœ¨å…¶ä»–ç”µè„‘éƒ½èƒ½æ­£å¸¸æ›´æ–°å‡çº§ï¼Œè¿™å°ç”µè„‘å°±ä¸èƒ½ä½¿ç”¨å‡çº§äº†**

## æ ¹æœ¬åŸå› åˆ†æ

ç»è¿‡æ·±å…¥è¯Šæ–­ï¼Œå‘ç°é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ï¼š

### ğŸ” **ç½‘ç»œé…ç½®å†²çª**

åŸå§‹çš„ `UpdateManager` ä»£ç ä¸­å­˜åœ¨ä¸€ä¸ªä¸¥é‡çš„ç½‘ç»œé…ç½®é—®é¢˜ï¼š

```python
# é—®é¢˜ä»£ç 
session = requests.Session()
session.trust_env = False  # ç¦ç”¨ç¯å¢ƒå˜é‡
session.proxies = {}       # æ¸…ç©ºä»£ç†è®¾ç½®
```

**é—®é¢˜åˆ†æï¼š**
- åŒæ—¶è®¾ç½® `trust_env=False` å’Œ `proxies={}` ä¼šå¯¼è‡´ DNS è§£æå¤±è´¥
- åœ¨æŸäº›ç½‘ç»œç¯å¢ƒä¸‹ï¼Œè¿™ç§é…ç½®ä¼šé˜»æ­¢æ­£å¸¸çš„åŸŸåè§£æ
- å¯¼è‡´ `codeload.github.com` æ— æ³•è®¿é—®ï¼Œå‡ºç° `getaddrinfo failed` é”™è¯¯

### ğŸŒ **ç¯å¢ƒå·®å¼‚**

ä¸åŒç”µè„‘çš„ç½‘ç»œç¯å¢ƒå·®å¼‚ï¼š
- **æ­£å¸¸ç”µè„‘**: ç½‘ç»œé…ç½®å…è®¸ç»•è¿‡è¿™ä¸ªé—®é¢˜
- **é—®é¢˜ç”µè„‘**: ç½‘ç»œé…ç½®è§¦å‘äº†DNSè§£æå†²çª

## ä¿®å¤æ–¹æ¡ˆ

### âœ… **æ™ºèƒ½ç½‘ç»œé…ç½®**

ä¿®æ”¹ `services/update_manager.py` ä¸­çš„ç½‘ç»œé…ç½®é€»è¾‘ï¼š

```python
# ä¿®å¤åçš„ä»£ç 
session = requests.Session()
# åªåœ¨æ£€æµ‹åˆ°ä»£ç†ç¯å¢ƒå˜é‡æ—¶æ‰ç¦ç”¨ï¼Œé¿å…DNSè§£æé—®é¢˜
import os
has_proxy = any(os.environ.get(var) for var in ['HTTP_PROXY', 'HTTPS_PROXY', 'http_proxy', 'https_proxy'])
if has_proxy:
    session.trust_env = False
    session.proxies = {}
```

### ğŸ¯ **ä¿®å¤åŸç†**

1. **æ¡ä»¶æ€§é…ç½®**: åªæœ‰åœ¨æ£€æµ‹åˆ°ä»£ç†ç¯å¢ƒå˜é‡æ—¶æ‰ç¦ç”¨ç¯å¢ƒå˜é‡ä¿¡ä»»
2. **ä¿æŒå…¼å®¹**: åœ¨æ— ä»£ç†ç¯å¢ƒä¸‹ä½¿ç”¨é»˜è®¤ç½‘ç»œé…ç½®
3. **é¿å…å†²çª**: é˜²æ­¢ä¸å¿…è¦çš„ç½‘ç»œé…ç½®è¦†ç›–å¯¼è‡´DNSé—®é¢˜

## ä¿®å¤æ•ˆæœéªŒè¯

### ğŸ§ª **æµ‹è¯•ç»“æœ**

```
ğŸ”§ æµ‹è¯•å‡çº§åŠŸèƒ½ä¿®å¤æ•ˆæœ
==================================================

ğŸ“‹ å½“å‰ç‰ˆæœ¬: 1.0.0
ğŸ“‹ UpdateManagerç‰ˆæœ¬: 1.0.0

ğŸ” æµ‹è¯•æ£€æŸ¥æ›´æ–°åŠŸèƒ½...
âœ… æ£€æŸ¥æ›´æ–°æˆåŠŸ
   æœ€æ–°ç‰ˆæœ¬: 1.0.4
   å‘å¸ƒè¯´æ˜: ä¼˜åŒ–æµè§ˆå™¨æˆªå›¾...
   æœ‰æ–°ç‰ˆæœ¬: æ˜¯

ğŸŒ æµ‹è¯•ç½‘ç»œè¿æ¥...
âœ… GitHub APIè¿æ¥æ­£å¸¸
âœ… ä¸‹è½½é“¾æ¥å¯è®¿é—®

âš™ï¸  æ£€æŸ¥é…ç½®...
âœ… GitHubé…ç½®æ­£å¸¸: yuanxiao9889/MJ-translate

==================================================
ğŸ‰ å‡çº§åŠŸèƒ½æµ‹è¯•å®Œæˆï¼
```

### âœ… **å®é™…å‡çº§æµ‹è¯•**

```
æµ‹è¯•ä¿®å¤åçš„å‡çº§åŠŸèƒ½...
5% - è·å–æ›´æ–°ä¿¡æ¯: æ­£åœ¨è¿æ¥GitHub API...
10% - è·å–ä¸‹è½½é“¾æ¥: æ­£åœ¨è§£æä¸‹è½½åœ°å€...
20% - åˆ›å»ºå¤‡ä»½: æ­£åœ¨å¤‡ä»½å½“å‰ç‰ˆæœ¬...
30% - ä¸‹è½½æ›´æ–°: æ­£åœ¨ä¸‹è½½ MJ-translate-v1.0.4.zip...
70% - ä¸‹è½½å®Œæˆ: æ–‡ä»¶å·²ä¸‹è½½åˆ° ...
80% - åº”ç”¨æ›´æ–°: æ­£åœ¨è§£å‹å’Œåº”ç”¨æ›´æ–°...
95% - æ¸…ç†æ–‡ä»¶: æ­£åœ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶...
100% - æ›´æ–°å®Œæˆ: æ›´æ–°å·²æˆåŠŸåº”ç”¨ï¼
å‡çº§ç»“æœ: True
```

## ä½¿ç”¨è¯´æ˜

### ğŸš€ **å¦‚ä½•ä½¿ç”¨ä¿®å¤åçš„å‡çº§åŠŸèƒ½**

1. **é€šè¿‡UIç•Œé¢**ï¼š
   - æ‰“å¼€ç¨‹åº
   - ç‚¹å‡» "è®¾ç½®" -> "å…³äºä¸æ›´æ–°" -> "æ£€æŸ¥æ›´æ–°"
   - å¦‚æœ‰æ–°ç‰ˆæœ¬ï¼Œç‚¹å‡» "ç«‹å³æ›´æ–°"

2. **é€šè¿‡ä»£ç **ï¼š
   ```python
   from services.update_manager import UpdateManager
   updater = UpdateManager()
   
   # æ£€æŸ¥æ›´æ–°
   latest_version, release_notes = updater.check_for_updates()
   
   # æ‰§è¡Œå‡çº§
   if updater.is_new_version_available(latest_version):
       result = updater.download_and_apply_update()
   ```

### ğŸ›¡ï¸ **å®‰å…¨ç‰¹æ€§**

- âœ… **è‡ªåŠ¨å¤‡ä»½**: å‡çº§å‰è‡ªåŠ¨å¤‡ä»½å½“å‰ç‰ˆæœ¬
- âœ… **å¤±è´¥å›æ»š**: å‡çº§å¤±è´¥æ—¶è‡ªåŠ¨æ¢å¤
- âœ… **ç½‘ç»œé‡è¯•**: ç½‘ç»œé—®é¢˜æ—¶è‡ªåŠ¨é‡è¯•
- âœ… **ç¦»çº¿æ¨¡å¼**: ç½‘ç»œä¸å¯ç”¨æ—¶æä¾›æ‰‹åŠ¨å‡çº§æŒ‡å—

## æŠ€æœ¯ç»†èŠ‚

### ğŸ“ **ä¿®æ”¹çš„æ–‡ä»¶**

- `services/update_manager.py`: æ ¸å¿ƒå‡çº§ç®¡ç†é€»è¾‘
  - `check_for_updates()` æ–¹æ³•
  - `_download_with_retry()` æ–¹æ³•  
  - `download_and_apply_update()` æ–¹æ³•

### ğŸ”§ **ä¿®å¤çš„æ–¹æ³•**

1. **check_for_updates()**: ä¿®å¤GitHub APIè®¿é—®çš„ç½‘ç»œé…ç½®
2. **_download_with_retry()**: ä¿®å¤æ–‡ä»¶ä¸‹è½½çš„ç½‘ç»œé…ç½®
3. **download_and_apply_update()**: ä¿®å¤å®Œæ•´å‡çº§æµç¨‹çš„ç½‘ç»œé…ç½®

## æ•…éšœæ’é™¤

### ğŸ” **å¦‚æœä»æœ‰é—®é¢˜**

1. **æ£€æŸ¥ç½‘ç»œè¿æ¥**:
   ```bash
   python network_diagnosis.py
   ```

2. **æ‰‹åŠ¨æµ‹è¯•å‡çº§**:
   ```bash
   python test_upgrade_fix.py
   ```

3. **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**:
   - æ£€æŸ¥ `logs/mj_translator.log`
   - æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º

### ğŸŒ **ç½‘ç»œç¯å¢ƒå»ºè®®**

- **ä¼ä¸šç½‘ç»œ**: è”ç³»ç½‘ç»œç®¡ç†å‘˜ç¡®è®¤GitHubè®¿é—®æƒé™
- **é˜²ç«å¢™**: ç¡®ä¿å…è®¸è®¿é—® `api.github.com` å’Œ `codeload.github.com`
- **DNSè®¾ç½®**: å¦‚æœ‰é—®é¢˜å¯å°è¯•ä½¿ç”¨å…¬å…±DNS (8.8.8.8, 114.114.114.114)

## æ€»ç»“

### âœ… **ä¿®å¤çŠ¶æ€**: å·²å®Œæˆ
### âœ… **æµ‹è¯•çŠ¶æ€**: å·²é€šè¿‡  
### âœ… **å…¼å®¹æ€§**: ä¿æŒå‘åå…¼å®¹

**è¿™ä¸ªä¿®å¤è§£å†³äº†ç½‘ç»œé…ç½®å†²çªå¯¼è‡´çš„DNSè§£æé—®é¢˜ï¼Œç°åœ¨å‡çº§åŠŸèƒ½åº”è¯¥åœ¨æ‰€æœ‰ç”µè„‘ä¸Šéƒ½èƒ½æ­£å¸¸å·¥ä½œäº†ã€‚**

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2024å¹´1æœˆ  
**ä¿®å¤ç‰ˆæœ¬**: åŸºäºå½“å‰ä»£ç åº“  
**æŠ€æœ¯æ”¯æŒ**: å¦‚æœ‰é—®é¢˜è¯·æŸ¥çœ‹æ—¥å¿—æˆ–è¿è¡Œè¯Šæ–­è„šæœ¬